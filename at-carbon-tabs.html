<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
`at-carbon-tabs` makes it easy to explore and switch between different views or functional aspects of
an app, or to browse categorized data sets.

Use `selected` property to get or set the selected tab.

Example:

    <at-carbon-tabs selected="0">
      <at-carbon-tab>TAB 1</at-carbon-tab>
      <at-carbon-tab>TAB 2</at-carbon-tab>
      <at-carbon-tab>TAB 3</at-carbon-tab>
    </at-carbon-tabs>

See <a href="#at-carbon-tab">at-carbon-tab</a> for more information about
`at-carbon-tab`.

A common usage for `at-carbon-tabs` is to use it along with `iron-pages` to switch
between different views.

    <at-carbon-tabs selected="{{selected}}">
      <at-carbon-tab>Tab 1</at-carbon-tab>
      <at-carbon-tab>Tab 2</at-carbon-tab>
      <at-carbon-tab>Tab 3</at-carbon-tab>
    </at-carbon-tabs>

    <iron-pages selected="{{selected}}">
      <div>Page 1</div>
      <div>Page 2</div>
      <div>Page 3</div>
    </iron-pages>


To use links in tabs, add `link` attribute to `at-carbon-tab` and put an `<a>`
element in `at-carbon-tab`.

Example:

    <at-carbon-tabs selected="0">
      <at-carbon-tab link>
        <a href="#link1" class="horizontal center-center layout">TAB ONE</a>
      </at-carbon-tab>
      <at-carbon-tab link>
        <a href="#link2" class="horizontal center-center layout">TAB TWO</a>
      </at-carbon-tab>
      <at-carbon-tab link>
        <a href="#link3" class="horizontal center-center layout">TAB THREE</a>
      </at-carbon-tab>
    </at-carbon-tabs>

@group Paper Elements
@element at-carbon-tabs
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../layout/layout.html">

<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">

<link rel="import" href="../at-core-resize-sensor/at-core-resize-sensor.html">

<dom-module id="at-carbon-tabs">

  <style>
    :host {
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
      -ms-flex-align: center;
      -webkit-align-items: center;
      align-items: center;
      height: 48px;
      font-size: 14px;
      font-weight: 500;
      overflow: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    #tabsContent {
      height: 100%;
    }

    #tabsContent.scrollable {
      position: absolute;
      white-space: nowrap;
    }

    #selectionBar {
      position: absolute;
      height: 2px;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #03a9f4;
      -webkit-transform-origin: left center;
      transform-origin: left center;
      -webkit-transform: scale(0);
      transform: scale(0);
      transition: -webkit-transform;
      transition: transform;
    }

    #selectionBar.align-bottom {
      top: 0;
      bottom: auto;
    }

    #selectionBar.expand {
      transition-duration: 0.15s;
      transition-timing-function: cubic-bezier(0.4, 0.0, 1, 1);
    }

    #selectionBar.contract {
      transition-duration: 0.18s;
      transition-timing-function: cubic-bezier(0.0, 0.0, 0.2, 1);
    }

    #tabsContent >::content > *:not(#selectionBar) {
      height: 100%;
    }

    .wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .clear-float {
      clear: both;
    }

    .scroll-button-container {
      position: absolute;
      width: 24px;
      height: 24px;
      top: 50%;
      transform: translateY(-50%);
    }

    .scroll-button-container.left {
      left: 0;
    }

    .scroll-button-container.right {
      right: 0;
    }

    .scroll-button-container > .scroll-button {}

    .scroll-button-container > .scroll-button.hide {
      display: none;
      opacity: 0;
    }

    .content-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #tabsContainer {
      position: relative;
      height: 100%;
      white-space: nowrap;
      overflow: hidden;
      margin: 0 24px;
    }
  </style>

  <template>
    <at-core-theme></at-core-theme>
    <div class="wrapper">
      <at-core-resize-sensor id="resizeSensor"></at-core-resize-sensor>
      <div class="clear-float"></div>
      <div id="contentWrapper" class="content-wrapper">
        <div id="leftScrollButton" hidden$="[[_computeScrollButtonHidden(scrollable, hideScrollButton)]]" class="scroll-button-container left">
          <at-carbon-icon icon="caret-left" class$="[[_computeIconClass(leftHidden)]] scroll-button" on-down="_onLeftScrollButtonDown" on-up="_onScrollButtonUp"></at-carbon-icon>
        </div>

        <div id="tabsContainer" class="flex" on-scroll="_scroll">

          <iron-selector id="tabsContent" class$="[[_computeTabsContentClass(scrollable)]]" selected="{{selected}}" selected-item="{{_tab}}" attr-for-selected="[[attrForSelected]]" selectable="at-carbon-tab">

            <content select="*"></content>

            <div id="selectionBar" class$="[[_computeSelectionBarClass(nobar, alignBottom)]] scroll-button" on-transitionend="_onBarTransitionEnd"></div>

          </iron-selector>

        </div>

        <div id="rightScrollButton" hidden$="[[_computeScrollButtonHidden(scrollable, hideScrollButton)]]" class="scroll-button-container right">
          <at-carbon-icon icon="caret-right" class$="[[_computeIconClass(rightHidden)]] scroll-button" on-down="_onRightScrollButtonDown" on-up="_onScrollButtonUp"></at-carbon-icon>
        </div>
      </div>
    </div>

  </template>

</dom-module>

<script>
  Polymer({

    is: 'at-carbon-tabs',

    behaviors: [
      Polymer.IronResizableBehavior
    ],

    properties: {

      /**
       * If true, the bottom bar to indicate the selected tab will not be shown.
       *
       * @attribute nobar
       * @type Boolean
       * @default false
       */
      nobar: {
        type: Boolean,
        value: false
      },

      /**
       * If true, the slide effect for the bottom bar is disabled.
       *
       * @attribute noslide
       * @type Boolean
       * @default false
       */
      noslide: {
        type: Boolean,
        value: false
      },

      /**
       * If true, tabs are scrollable and the tab width is based on the label width.
       *
       * @attribute scrollable
       * @type Boolean
       * @default false
       */
      scrollable: {
        type: Boolean,
        value: false
      },

      /**
       * If true, dragging on the tabs to scroll is disabled.
       *
       * @attribute disableDrag
       * @type Boolean
       * @default false
       */
      disableDrag: {
        type: Boolean,
        value: false
      },

      /**
       * If true, scroll buttons (left/right arrow) will be hidden for scrollable tabs.
       *
       * @attribute hideScrollButton
       * @type Boolean
       * @default false
       */
      hideScrollButton: {
        type: Boolean,
        value: false
      },

      /**
       * If true, the tabs are aligned to bottom (the selection bar appears at the top).
       *
       @attribute alignBottom
       @type Boolean
       @default false
       */
      alignBottom: {
        type: Boolean,
        value: false
      },

      /**
       * Gets or sets the selected element. The default is to use the index of the item.
       *
       * @attribute selected
       * @type {string}
       */
      selected: {
        type: String,
        notify: true,
        observer: 'selectedChanged'
      },

      _step: {
        value: 10
      },

      _holdDelay: {
        value: 1
      },

      _tab: {
        observer: '_tabChanged'
      }

    },

    listeners: {
      'iron-resize': '_onResize'
    },

    _scopeCssViaAttr: true,
    attached: function() {
      this.notifyResize();
      var self = this;
      var resizeSensor = this.$.resizeSensor;
      var tabsContainer = this.$.tabsContainer;
      var rightButtonWidth = this.$.rightScrollButton.getBoundingClientRect().width;
      resizeSensor.reset();
      resizeSensor.addEventListener('resize-sensed', function(event) {
        var tcWidth = tabsContainer.scrollWidth;
        var carbonTabsWidth = self.scrollWidth - rightButtonWidth;
        self.rightHidden = carbonTabsWidth > tcWidth;
      });
    },

    /**
     * This function switches the current tab to the tab with tabId
     */
    selectedChanged: function(newValue, oldValue) {
      this.fire('tab-changed', {
        value: {
          currentTab: newValue,
          previousTab: oldValue
        }
      });
    },

    _computeScrollButtonHidden: function(scrollable, hideScrollButton) {
      return !this.scrollable || this.hideScrollButton;
    },

    _computeIconClass: function(hidden) {
      if (hidden) {
        return 'hide';
      }
    },

    _computeTabsContentClass: function(scrollable) {
      return scrollable ? 'scrollable' : 'horizontal layout';
    },

    _computeSelectionBarClass: function(nobar, alignBottom) {
      if (nobar) {
        return 'hidden';
      } else if (alignBottom) {
        return 'align-bottom';
      }
    },

    // TODO(cdata): Add `track` response back in when gesture lands.

    _onResize: function() {
      this.debounce('_onResize', function() {
        this._scroll();
        this._tabChanged(this._tab);
      }, 10);
    },

    get _tabContainerScrollSize() {
      return Math.max(
        0,
        this.$.tabsContainer.scrollWidth -
        this.$.tabsContainer.scrollHeight
      );
    },

    _scroll: function() {
      var scrollLeft;

      if (!this.scrollable) {
        return;
      }

      scrollLeft = this.$.tabsContainer.scrollLeft;
      var tabContainerScrollSize = this._tabContainerScrollSize;
      var width = this.$.tabsContainer.getBoundingClientRect().width;
      var scrollWidth = this.$.tabsContainer.scrollWidth;
      this.leftHidden = scrollLeft === 0;
      this.rightHidden = Math.ceil(scrollLeft + width) === Math.ceil(scrollWidth);
    },

    _onLeftScrollButtonDown: function() {
      this._holdJob = setInterval(this._scrollToLeft.bind(this), this._holdDelay);
    },

    _onRightScrollButtonDown: function() {
      this._holdJob = setInterval(this._scrollToRight.bind(this), this._holdDelay);
    },

    _onScrollButtonUp: function() {
      clearInterval(this._holdJob);
      this._holdJob = null;
    },

    _scrollToLeft: function() {
      this.$.tabsContainer.scrollLeft -= this._step;
    },

    _scrollToRight: function() {
      this.$.tabsContainer.scrollLeft += this._step;
    },

    _tabChanged: function(tab) {
      if (!tab) {
        //        this._positionBar(0, 0);
        return;
      }

      var r = this.$.tabsContent.getBoundingClientRect();
      var w = r.width;
      var tabRect = tab.getBoundingClientRect();
      var tabOffsetLeft = tabRect.left - r.left;

      this._pos = {
        width: this._calcPercent(tabRect.width, w),
        left: this._calcPercent(tabOffsetLeft, w)
      };

      if (!this._old && !this.noslide) {
        this._old = tab;
      }

      if (this.noslide || this._old == null) {
        // position bar directly without animation
        this._positionBar(this._pos.width, this._pos.left);
        return;
      }

      var oldRect = this._old.getBoundingClientRect();
      var oldIndex = this.$.tabsContent.indexOf(this._old);
      var index = this.$.tabsContent.indexOf(tab);
      var m = 5;

      // bar animation: expand
      this.$.selectionBar.classList.add('expand');

      if (oldIndex < index) {
        this._positionBar(this._calcPercent(tabRect.left + tabRect.width - oldRect.left, w) - m, this._left);
      } else {
        this._positionBar(this._calcPercent(oldRect.left + oldRect.width - tabRect.left, w) - m, this._calcPercent(tabOffsetLeft, w) + m);
      }

      if (this.scrollable) {
        this._scrollToSelectedIfNeeded(tabRect.width, tabOffsetLeft);
      }

      if (!this.noslide) {
        this._old = tab;
      }
    },

    _scrollToSelectedIfNeeded: function(tabWidth, tabOffsetLeft) {
      var l = tabOffsetLeft - this.$.tabsContainer.scrollLeft;
      if (l < 0) {
        this.$.tabsContainer.scrollLeft += l;
      } else {
        l += (tabWidth - this.$.tabsContainer.offsetWidth);
        if (l > 0) {
          this.$.tabsContainer.scrollLeft += l;
        }
      }
    },

    _calcPercent: function(w, w0) {
      return 100 * w / w0;
    },

    _positionBar: function(width, left) {
      this._width = width;
      this._left = left;
      this.transform('translate3d(' + left + '%, 0, 0) scaleX(' + (width / 100) + ')', this.$.selectionBar);
    },

    _onBarTransitionEnd: function(e) {
      var cl = this.$.selectionBar.classList;
      // bar animation: expand -> contract
      if (cl.contains('expand')) {
        cl.remove('expand');
        cl.add('contract');
        this._positionBar(this._pos.width, this._pos.left);
        // bar animation done
      } else if (cl.contains('contract')) {
        cl.remove('contract');
      }
    }

  });
</script>
